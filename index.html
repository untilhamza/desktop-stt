<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello World!</title>
  </head>

  <body>
    <h1>Hello World!!** test</h1>
    We are using node
    <div>
      <button id="start">Start</button>
      <button id="stop">Stop</button>
    </div>
    <!-- put red border and make video element seen -->
    <div style="border: 1px solid red; width: 1280px; height: 720px">
      <video
        id="video"
        autoplay
        playsinline
        muted
        style="width: 1280px; height: 720px"
      ></video>
    </div>

    <!-- canvas -->
    <div style="border: 1px solid red; width: 640px; height: 720px">
      <canvas id="canvas" width="640" height="720"></canvas>
    </div>

    <!-- cropped video -->
    <div style="border: 1px solid red; width: 640px; height: 720px">
      <video
        id="cropped-video"
        autoplay
        playsinline
        muted
        style="width: 640px; height: 720px"
      ></video>

    <audio />
    <script>
      document.write(process.versions.node);
    </script>
    , Chrome
    <script>
      document.write(process.versions.chrome);
    </script>
    , and Electron
    <script>
      document.write(process.versions.electron);
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <!-- <script src="/socket.io/socket.io.js"></script> -->
    <script type="module">
      // import { io } from "https://cdn.socket.io/4.4.1/socket.io.esm.min.js";
      // const SOCKET_ADDRESS = "http://localhost:3005";
      // const socket = io.connect(SOCKET_ADDRESS);
      // socket.on("connect", () => {
      //   console.log("connected to server");
      // });

      // socket.on("disconnect", () => {
      //   console.log("disconnected from server");
      // });

      // socket.on("message", (data) => {
      //   console.log(data);
      // });

      // socket.on("error", (error) => {
      //   console.log(error);
      //});
    </script>
    <script>
      //In the preload script.
      const { ipcRenderer } = require("electron");
      console.log(ipcRenderer);
      ipcRenderer.on("SET_SOURCE", async (event, sourceId) => {
        console.log("** sourceId: " + sourceId);

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              mandatory: {
                chromeMediaSource: "desktop",
                chromeMediaSourceId: sourceId,
                echoCancellation: true,
                googAutoGainControl: true,
                googNoiseSuppression: true,
                googHighpassFilter: true,
                googAudioMirroring: true,
              },
              optional: [],
            },

            video: {
              mandatory: {
                chromeMediaSource: "desktop",
                chromeMediaSourceId: sourceId,
                minWidth: 1280,
                maxWidth: 1280,
                minHeight: 720,
                maxHeight: 720,
              },
            },
          });
          handleStream(stream);
        } catch (e) {
          handleError(e);
        }
      });

      function handleStream(stream) {
        console.log("stream", stream);
        const video = document.querySelector("video");
        const canvas = document.querySelector("#canvas");
        video.srcObject = stream;
        video.onloadedmetadata = (e) => {video.play()
        canvas.width=500;
      canvas.height=500;
    };
        //TODO: Crop stream
        const audioTrack = stream.getAudioTracks()[0];
        //const canvas = document.createElement("canvas");
      
        const ctx = canvas.getContext("2d");
        // canvas.width = video.videoWidth / 2; //1280;
        // canvas.height = video.videoHeight/2; //720;

        const draw = () => {
         // ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          //  setTimeout(draw, 1000 / 30);
          ctx.drawImage(video, 80,0,480,500,0,0,500,520);
          requestAnimationFrame(draw);
        };

        draw();

        const croppedStream = new MediaStream([audioTrack]);
        croppedStream.addTrack(canvas.captureStream().getVideoTracks()[0]);


        //show cropped video
        const croppedVideo = document.querySelector("#cropped-video");
        croppedVideo.srcObject = croppedStream;
        croppedVideo.onloadedmetadata = (e) => croppedVideo.play();


        //TODO: Record stream
        const mediaRecorder = new MediaRecorder(croppedStream);
       // mediaRecorder.start();
        let recordedBlobs = [];
        mediaRecorder.ondataavailable = (e) => {
          console.log("media data", e.data);
          recordedBlobs.push(e.data);
        };
        setTimeout(() => {
          mediaRecorder.stop();
        }, 30000);

        mediaRecorder.onstop = (e) => {
          console.log("recording stopped");
          const blob = new Blob(recordedBlobs, { type: "video/webm" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.style.display = "none";
          a.href = url;
          a.download = "recorded-stream.webm";
          document.body.appendChild(a);
          a.click();
        };
      }

      function handleError(e) {
        console.log(e);
      }

      // Async message handler
      ipcRenderer.on("asynchronous-reply", (event, arg) => {
        console.log("asynchronous-reply ", arg);
      });

      // Async message sender
      ipcRenderer.send("GET_SOURCE", "ping to main from primary html file");
    </script>
  </body>
</html>
